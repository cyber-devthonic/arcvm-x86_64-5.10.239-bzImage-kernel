name: Patch ARCVM bzImage x86_64-5.10.239 with KPM

on:
  workflow_dispatch:
  workflow_call:

jobs:
  patch-kernel:
    name: Download and Patch bzImage
    runs-on: ubuntu-latest

    steps:
      - name: Download ARCVM bzImage
        run: |
          mkdir -p kernel_artifacts
          cd kernel_artifacts
          wget https://github.com/cyber-devthonic/arcvm-x86_64-5.10.239-bzImage-kernel/raw/main/bzImage
          ls -lh bzImage

      - name: Download SukiSU KPM Patch Tool
        run: |
          cd kernel_artifacts
          wget https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux -O patch
          chmod +x patch
          ls -lh patch

      - name: Apply KPM Patch to bzImage
        working-directory: kernel_artifacts
        run: |
          echo "Applying SukiSU-Ultra KPM patch to bzImage..."
          ./patch || true

          # Check if patch succeeded (creates obzImage)
          if [ -f "obzImage" ]; then
            echo "KPM patch applied successfully"
            mv obzImage bzImage
            echo "Replaced original bzImage with patched version"
            ls -lh bzImage
          else
            echo "KPM patching may have failed - obzImage not found"
            echo "Using original bzImage"
          fi

      - name: Upload Patched Kernel
        uses: actions/upload-artifact@v4
        with:
          name: arcvm-x86-64-5.10.239-bzImage-KPM-patched
          path: kernel_artifacts/bzImage
